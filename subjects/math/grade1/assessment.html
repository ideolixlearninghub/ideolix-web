<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 1 Math Assessment - Ideolix Learning Hub</title>
    <!-- [KEEP ALL THE SAME CSS STYLES FROM BEFORE] -->
    <style>
        /* ALL THE SAME CSS AS BEFORE */
    </style>
</head>
<body>
    <div class="quiz-container">
        <!-- [KEEP ALL THE SAME HTML STRUCTURE AS BEFORE] -->
    </div>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="../../js/math-engine.js"></script>
    <script>
        // PROPER ASSESSMENT USING MATH ENGINE
        function generateAssessmentQuestions() {
            const curriculum = MathEngine.getCurriculum(1);
            const questions = [];
            
            console.log("Generating assessment questions..."); // Debug
            
            // Generate questions from ALL topics
            curriculum.topics.forEach(topic => {
                // Generate 3 questions from each topic
                for (let i = 0; i < 3; i++) {
                    try {
                        const problem = MathEngine.generateProblem(1, topic.id);
                        console.log(`Generated ${topic.id} problem:`, problem); // Debug
                        
                        if (problem && problem.text && problem.answer !== undefined) {
                            const mcProblem = convertToMultipleChoice(problem, topic.id);
                            questions.push(mcProblem);
                        }
                    } catch (error) {
                        console.error(`Error generating ${topic.id} problem:`, error);
                        // Add a fallback question
                        questions.push(createFallbackQuestion(topic));
                    }
                }
            });
            
            // Fill remaining slots if needed (should be 10 topics Ã— 3 = 30 questions)
            while (questions.length < 30) {
                const randomTopic = curriculum.topics[Math.floor(Math.random() * curriculum.topics.length)];
                try {
                    const problem = MathEngine.generateProblem(1, randomTopic.id);
                    if (problem && problem.text) {
                        const mcProblem = convertToMultipleChoice(problem, randomTopic.id);
                        questions.push(mcProblem);
                    }
                } catch (error) {
                    console.error("Error generating additional question:", error);
                    questions.push(createFallbackQuestion(randomTopic));
                }
            }
            
            console.log("Final questions:", questions); // Debug
            return questions.slice(0, 30); // Ensure exactly 30 questions
        }

        function convertToMultipleChoice(problem, topic) {
            let correctAnswer = problem.answer;
            let wrongAnswers = [];
            
            // Generate plausible wrong answers based on the correct answer
            if (typeof correctAnswer === 'number') {
                // For numeric answers
                wrongAnswers = [
                    correctAnswer + 1,
                    correctAnswer - 1,
                    correctAnswer + 2,
                    Math.max(1, correctAnswer - 2),
                    correctAnswer + 5,
                    Math.max(1, correctAnswer - 5)
                ].filter((val, index, self) => 
                    val !== correctAnswer && 
                    val > 0 && 
                    self.indexOf(val) === index
                ).slice(0, 3);
            } else {
                // For text answers, create variations
                const text = correctAnswer.toString().toLowerCase();
                if (text.includes('tens') || text.includes('ones')) {
                    wrongAnswers = [
                        text.replace('tens', 'ones').replace('ones', 'tens'),
                        '0 tens and 0 ones',
                        '10 tens and 0 ones'
                    ];
                } else if (text.includes('half past') || text.includes("o'clock")) {
                    wrongAnswers = [
                        text.includes('half past') ? text.replace('half past', "o'clock") : text.replace("o'clock", 'half past'),
                        '12:00',
                        '6:30'
                    ];
                } else {
                    wrongAnswers = ['different answer', 'another answer', 'wrong answer'];
                }
            }
            
            // Ensure we have exactly 3 wrong answers
            while (wrongAnswers.length < 3) {
                if (typeof correctAnswer === 'number') {
                    wrongAnswers.push(correctAnswer + wrongAnswers.length + 1);
                } else {
                    wrongAnswers.push(`option ${wrongAnswers.length + 1}`);
                }
            }
            
            // Combine and shuffle options
            const allOptions = [correctAnswer, ...wrongAnswers.slice(0, 3)];
            const shuffledOptions = allOptions.sort(() => Math.random() - 0.5);
            
            return {
                text: problem.text,
                options: shuffledOptions,
                correctAnswer: shuffledOptions.indexOf(correctAnswer),
                type: topic,
                explanation: problem.explanation || `The correct answer is ${correctAnswer}`
            };
        }

        function createFallbackQuestion(topic) {
            const fallbacks = {
                'counting': {
                    text: "What number comes after 15?",
                    answer: 16,
                    explanation: "After 15 comes 16"
                },
                'addition': {
                    text: "What is 5 + 3?",
                    answer: 8,
                    explanation: "5 + 3 = 8"
                },
                'subtraction': {
                    text: "What is 10 - 4?",
                    answer: 6,
                    explanation: "10 - 4 = 6"
                },
                'place-value': {
                    text: "How many tens in 25?",
                    answer: 2,
                    explanation: "25 has 2 tens and 5 ones"
                },
                'time': {
                    text: "What time is 3 o'clock?",
                    answer: "3:00",
                    explanation: "3 o'clock is 3:00"
                },
                'money': {
                    text: "How many cents is 1 dime?",
                    answer: 10,
                    explanation: "1 dime = 10 cents"
                },
                'geometry': {
                    text: "How many sides does a triangle have?",
                    answer: 3,
                    explanation: "A triangle has 3 sides"
                }
            };
            
            const fallback = fallbacks[topic.id] || fallbacks.counting;
            const mcProblem = convertToMultipleChoice(fallback, topic.id);
            return mcProblem;
        }

        // Quiz Logic
        let questions = [];
        let currentQuestion = 0;
        let userAnswers = [];
        let timeLeft = 2400; // 40 minutes
        let timerInterval;
        let quizStarted = false;

        function startQuiz() {
            console.log("Start button clicked - generating questions...");
            
            // Generate questions
            questions = generateAssessmentQuestions();
            userAnswers = new Array(questions.length).fill(null);
            
            if (questions.length === 0) {
                alert("Error: Could not generate questions. Please try again.");
                return;
            }
            
            quizStarted = true;
            document.getElementById('instructions-content').style.display = 'none';
            document.getElementById('quiz-timer').style.display = 'block';
            document.querySelector('.question-container').style.display = 'block';
            document.querySelector('.quiz-navigation').style.display = 'flex';
            document.querySelector('.question-numbers').style.display = 'flex';
            
            startTimer();
            showQuestion(0);
            generateQuestionNumbers();
            
            console.log("Quiz started with", questions.length, "questions");
        }

        // [KEEP ALL OTHER FUNCTIONS THE SAME: startTimer, updateTimer, showQuestion, etc.]
        function startTimer() {
            updateTimer();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimer();
                if (timeLeft <= 0) {
                    submitQuiz();
                } else if (timeLeft <= 300) {
                    document.getElementById('quiz-timer').classList.add('warning');
                }
            }, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function showQuestion(index) {
            if (!questions || questions.length === 0) {
                console.error("No questions available");
                return;
            }
            
            currentQuestion = index;
            const question = questions[index];
            
            document.getElementById('question-number').textContent = 
                `Question ${index + 1} of ${questions.length}`;
            document.getElementById('question-text').textContent = question.text;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, optionIndex) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                
                if (userAnswers[index] === optionIndex) {
                    optionElement.classList.add('selected');
                }
                
                optionElement.addEventListener('click', () => selectAnswer(optionIndex));
                optionsContainer.appendChild(optionElement);
            });
            
            updateNavigation();
            updateQuestionNumbers();
        }

        function selectAnswer(optionIndex) {
            userAnswers[currentQuestion] = optionIndex;
            updateOptions();
            updateQuestionNumbers();
        }

        function updateOptions() {
            const options = document.querySelectorAll('.option');
            options.forEach((option, index) => {
                if (index === userAnswers[currentQuestion]) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                showQuestion(currentQuestion + 1);
            }
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                showQuestion(currentQuestion - 1);
            }
        }

        function jumpToQuestion(index) {
            showQuestion(index);
        }

        function updateNavigation() {
            document.getElementById('prev-btn').disabled = currentQuestion === 0;
            document.getElementById('next-btn').disabled = currentQuestion === questions.length - 1;
        }

        function generateQuestionNumbers() {
            const container = document.getElementById('question-numbers');
            container.innerHTML = '';
            
            for (let i = 0; i < questions.length; i++) {
                const numberElement = document.createElement('div');
                numberElement.className = 'q-number';
                numberElement.textContent = i + 1;
                numberElement.addEventListener('click', () => jumpToQuestion(i));
                container.appendChild(numberElement);
            }
            
            updateQuestionNumbers();
        }

        function updateQuestionNumbers() {
            const numbers = document.querySelectorAll('.q-number');
            numbers.forEach((number, index) => {
                number.classList.remove('current', 'answered');
                
                if (index === currentQuestion) {
                    number.classList.add('current');
                }
                
                if (userAnswers[index] !== null) {
                    number.classList.add('answered');
                }
            });
        }

        function submitQuiz() {
            clearInterval(timerInterval);
            
            const score = calculateScore();
            showResults(score);
            
            // Save assessment results
            localStorage.setItem('grade1MathAssessment', JSON.stringify(score));
        }

        function calculateScore() {
            let correct = 0;
            const topicPerformance = {};
            
            // Initialize topic performance
            questions.forEach(question => {
                if (!topicPerformance[question.type]) {
                    topicPerformance[question.type] = { correct: 0, total: 0 };
                }
                topicPerformance[question.type].total++;
                
                const questionIndex = questions.indexOf(question);
                if (userAnswers[questionIndex] === question.correctAnswer) {
                    correct++;
                    topicPerformance[question.type].correct++;
                }
            });
            
            const percentage = Math.round((correct / questions.length) * 100);
            const unanswered = userAnswers.filter(answer => answer === null).length;
            
            return { 
                correct, 
                total: questions.length, 
                percentage, 
                unanswered,
                topicPerformance 
            };
        }

        function showResults(score) {
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('results-content').style.display = 'block';
            
            document.getElementById('final-score').textContent = score.correct;
            document.getElementById('total-questions').textContent = score.total;
            document.getElementById('score-percentage').textContent = score.percentage;
            
            // Set CSS variable for score circle
            document.documentElement.style.setProperty('--score-percent', `${score.percentage}%`);
            
            // Show topic breakdown
            showTopicBreakdown(score.topicPerformance);
            
            // Show recommendation
            const recommendation = getRecommendation(score.percentage, score.topicPerformance);
            document.getElementById('recommendation-text').textContent = recommendation;
            
            // Show unanswered count if any
            if (score.unanswered > 0) {
                document.getElementById('unanswered-count').textContent = score.unanswered;
                document.getElementById('unanswered-warning').style.display = 'block';
            }
        }

        function showTopicBreakdown(topicPerformance) {
            const container = document.getElementById('topic-breakdown');
            const curriculum = MathEngine.getCurriculum(1);
            const topicNames = {};
            
            curriculum.topics.forEach(topic => {
                topicNames[topic.id] = `${topic.icon} ${topic.name}`;
            });
            
            let html = '<h3>Topic Performance</h3>';
            
            Object.keys(topicPerformance).forEach(topic => {
                const performance = topicPerformance[topic];
                const percentage = Math.round((performance.correct / performance.total) * 100);
                const topicName = topicNames[topic] || topic;
                
                html += `
                    <div class="topic-item">
                        <span>${topicName}</span>
                        <span class="topic-score">${performance.correct}/${performance.total} (${percentage}%)</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getRecommendation(percentage, topicPerformance) {
            if (percentage >= 90) {
                return "Outstanding! You've mastered Grade 1 math! Ready for Grade 2!";
            } else if (percentage >= 70) {
                return "Great work! You have a solid understanding of Grade 1 math.";
            } else {
                // Find weakest topic
                let weakestTopic = null;
                let lowestScore = 100;
                
                Object.keys(topicPerformance).forEach(topic => {
                    const performance = topicPerformance[topic];
                    const score = (performance.correct / performance.total) * 100;
                    if (score < lowestScore) {
                        lowestScore = score;
                        weakestTopic = topic;
                    }
                });
                
                const curriculum = MathEngine.getCurriculum(1);
                const topicObj = curriculum.topics.find(t => t.id === weakestTopic);
                
                if (topicObj) {
                    return `Good effort! Focus on practicing ${topicObj.name.toLowerCase()} to improve your score.`;
                } else {
                    return "Keep practicing! You're building important math skills.";
                }
            }
        }

        // Initialize quiz
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded - setting up event listeners");
            
            // Set up event listeners
            const startBtn = document.getElementById('start-quiz-btn');
            if (startBtn) {
                startBtn.addEventListener('click', startQuiz);
                console.log("Start button event listener added");
            }
            
            document.getElementById('next-btn').addEventListener('click', nextQuestion);
            document.getElementById('prev-btn').addEventListener('click', prevQuestion);
            document.getElementById('submit-btn').addEventListener('click', submitQuiz);
            document.getElementById('retry-btn').addEventListener('click', () => window.location.reload());
        });
    </script>
</body>
</html>
